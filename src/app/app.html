<!-- app.component.html -->
<div class="orb orb1"></div>
<div class="orb orb2"></div>

<!-- HEADER -->
<header>
  <div class="badge">
    <span class="ef-logo">e<span>f</span></span>
    eFootball Rivalry Tracker
  </div>
  <h1>eFOOTBALL</h1>
  <p class="subtitle">SHAKTHI &nbsp;¬∑&nbsp; SHYNU &nbsp;¬∑&nbsp; RIVALRY STATS</p>
</header>

<!-- H2H BAR -->
<div class="h2h-wrap" *ngIf="me && friend">
  <div class="h2h-title">Head to Head ‚Äî Win Dominance</div>
  <div class="h2h-row">
    <div class="h2h-name me">{{ me.name.toUpperCase() }}</div>
    <div class="h2h-center">
      <div class="h2h-track">
        <div class="h2h-fill" [style.width.%]="h2hPercent()"></div>
      </div>
      <div class="h2h-nums">
        <span>{{ me.stats.wins }} wins</span>
        <span>{{ friend.stats.wins }} wins</span>
      </div>
    </div>
    <div class="h2h-name frd">{{ friend.name.toUpperCase() }}</div>
  </div>
  <div class="toggle-row">
    <button class="toggle-btn" [class.active]="viewMode === 'history'" (click)="toggleView()">
      <span class="toggle-icon">{{ viewMode === 'stats' ? 'üìã' : 'üìä' }}</span>
      <span>{{ viewMode === 'stats' ? 'MATCH HISTORY' : 'BACK TO STATS' }}</span>
    </button>
  </div>
</div>

<!-- LOADING -->
<div class="loading" *ngIf="!me || !friend">
  <div class="load-icon">
    <svg viewBox="0 0 40 40" class="ef-spin"><text x="4" y="30" font-size="28" font-weight="900" fill="url(#lg)">e</text>
      <defs>
        <linearGradient id="lg" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#00C8FF" />
          <stop offset="100%" stop-color="#FFD700" />
        </linearGradient>
      </defs>
    </svg>
  </div>
  <p>Loading stats...</p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STATS VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="arena" *ngIf="me && friend && viewMode === 'stats'" [@fadeSlide]>

  <!-- ME SIDE -->
  <div class="side me-side">
    <div class="p-header">
      <div class="avatar-wrap" (click)="triggerUpload('me')">
        <img *ngIf="mePhoto" [src]="mePhoto" class="avatar-img" alt="Shakthi" />
        <div *ngIf="!mePhoto" class="avatar me-av">{{ me.name.substring(0,2).toUpperCase() }}</div>
        <div class="avatar-overlay">üì∑</div>
        <input type="file" accept="image/*" #meFileInput (change)="onPhotoSelect($event, 'me')" style="display:none" />
      </div>
      <div class="p-info">
        <div class="p-name me-name">{{ me.name.toUpperCase() }}</div>
        <div class="p-sub">Shakthi's Stats</div>
        <div class="p-wr">{{ winRate(me) }}% WIN RATE</div>
      </div>
      <div class="p-goals-badge me-badge">
        <span class="goals-num">{{ me.stats.totalGoals }}</span>
        <span class="goals-lbl">GOALS</span>
      </div>
    </div>
    <div class="stats" [@listAnim]>
      <ng-container *ngFor="let def of statDefs">
        <div class="sec-label" *ngIf="def.section">{{ def.section }}</div>
        <div class="stat-card" [class.win]="meWins(def) && !isTie(def)">
          <div class="s-icon">{{ def.icon }}</div>
          <div class="s-info">
            <div class="s-label">{{ def.label }}</div>
            <div class="s-val">
              {{ getVal(me, def) }}
              <span class="star" *ngIf="meWins(def) && !isTie(def)">‚≠ê</span>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- CENTER ADD BUTTON -->
  <div class="center-col">
    <div class="add-btn-wrap">
      <button class="add-match-btn" (click)="openModal()" title="Add Match">
        <span class="add-plus">+</span>
        <span class="add-label">ADD</span>
      </button>
    </div>
  </div>

  <!-- FRIEND SIDE -->
  <div class="side frd-side">
    <div class="p-header">
      <div class="avatar-wrap" (click)="triggerUpload('friend')">
        <img *ngIf="friendPhoto" [src]="friendPhoto" class="avatar-img" alt="Shynu" />
        <div *ngIf="!friendPhoto" class="avatar frd-av">{{ friend.name.substring(0,2).toUpperCase() }}</div>
        <div class="avatar-overlay">üì∑</div>
        <input type="file" accept="image/*" #friendFileInput (change)="onPhotoSelect($event, 'friend')" style="display:none" />
      </div>
      <div class="p-info frd-info">
        <div class="p-name frd-name">{{ friend.name.toUpperCase() }}</div>
        <div class="p-sub">Shaynu's Stats</div>
        <div class="p-wr">{{ winRate(friend) }}% WIN RATE</div>
      </div>
      <div class="p-goals-badge frd-badge">
        <span class="goals-num">{{ friend.stats.totalGoals }}</span>
        <span class="goals-lbl">GOALS</span>
      </div>
    </div>
    <div class="stats" [@listAnim]>
      <ng-container *ngFor="let def of statDefs">
        <div class="sec-label frd-sec" *ngIf="def.section">{{ def.section }}</div>
        <div class="stat-card frd-card" [class.win]="friendWins(def) && !isTie(def)">
          <div class="s-icon">{{ def.icon }}</div>
          <div class="s-info frd-info-card">
            <div class="s-label">{{ def.label }}</div>
            <div class="s-val frd-val">
              <span class="star" *ngIf="friendWins(def) && !isTie(def)">‚≠ê</span>
              {{ getVal(friend, def) }}
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HISTORY VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="history-view" *ngIf="me && friend && viewMode === 'history'" [@fadeSlide]>

  <div class="history-header">
    <h2 class="history-title">MATCH HISTORY</h2>
    <span class="history-count">{{ matchHistory.length }} matches played</span>
  </div>

  <div class="history-empty" *ngIf="matchHistory.length === 0">
    <div class="empty-icon">üì≠</div>
    <p>No matches yet. Add your first match!</p>
    <button class="btn btn-submit" (click)="openModal()">+ Add First Match</button>
  </div>

  <div class="history-list" *ngIf="matchHistory.length > 0">
    <div class="history-card" *ngFor="let m of matchHistory; let i = index"
      [class.h-win]="m.result === 'win'"
      [class.h-draw]="m.result === 'draw'"
      [class.h-loss]="m.result === 'loss'" [@cardAnim]>

      <!-- Result ribbon -->
      <div class="h-ribbon" [class.r-win]="m.result === 'win'" [class.r-draw]="m.result === 'draw'" [class.r-loss]="m.result === 'loss'">
        {{ m.result === 'win' ? 'W' : m.result === 'draw' ? 'D' : 'L' }}
      </div>

      <!-- Date/Time header -->
      <div class="h-meta">
        <span class="h-date">{{ m.matchDate | date:'MMM d, yyyy' }}</span>
        <span class="h-time">{{ m.matchDate | date:'h:mm a' }}</span>
        <span class="h-num">#{{ matchHistory.length - i }}</span>
      </div>

      <!-- Score row -->
      <div class="h-score-row">
        <div class="h-player me-player">
          <div class="h-avatar" [class.h-av-me]="true">
            <img *ngIf="mePhoto" [src]="mePhoto" class="h-av-img" />
            <span *ngIf="!mePhoto">SK</span>
          </div>
          <div class="h-pname me-pname">{{ me.name }}</div>
          <div class="h-goals me-goals">
            {{ m.me_normalGoals + m.me_penaltyGoals + m.me_freekickGoals + m.me_cornerGoals + m.friend_ownGoals }}
            <span class="h-star" *ngIf="m.result === 'win'">‚≠ê</span>
          </div>
        </div>
        <div class="h-vs">VS</div>
        <div class="h-player frd-player">
          <div class="h-avatar" [class.h-av-frd]="true">
            <img *ngIf="friendPhoto" [src]="friendPhoto" class="h-av-img" />
            <span *ngIf="!friendPhoto">SH</span>
          </div>
          <div class="h-pname frd-pname">{{ friend.name }}</div>
          <div class="h-goals frd-goals">
            <span class="h-star" *ngIf="m.result === 'loss'">‚≠ê</span>
            {{ m.friend_normalGoals + m.friend_penaltyGoals + m.friend_freekickGoals + m.friend_cornerGoals + m.me_ownGoals }}
          </div>
        </div>
      </div>

      <!-- Goal breakdown -->
      <div class="h-breakdown">
        <div class="h-bk-side">
          <span *ngIf="m.me_penaltyGoals" class="bk-chip">üéØ {{ m.me_penaltyGoals }}P</span>
          <span *ngIf="m.me_freekickGoals" class="bk-chip">üåÄ {{ m.me_freekickGoals }}FK</span>
          <span *ngIf="m.me_cornerGoals" class="bk-chip">üìê {{ m.me_cornerGoals }}CK</span>
          <span *ngIf="m.me_ownGoals" class="bk-chip og-chip">üò¨ {{ m.me_ownGoals }}OG</span>
        </div>
        <div class="h-bk-side frd-bk">
          <span *ngIf="m.friend_ownGoals" class="bk-chip og-chip">üò¨ {{ m.friend_ownGoals }}OG</span>
          <span *ngIf="m.friend_cornerGoals" class="bk-chip">üìê {{ m.friend_cornerGoals }}CK</span>
          <span *ngIf="m.friend_freekickGoals" class="bk-chip">üåÄ {{ m.friend_freekickGoals }}FK</span>
          <span *ngIf="m.friend_penaltyGoals" class="bk-chip">üéØ {{ m.friend_penaltyGoals }}P</span>
        </div>
      </div>

      <!-- Action buttons: Edit + Delete -->
      <div class="h-actions">
        <button class="h-edit-btn" (click)="openEditMatch(i)">‚úé Edit</button>
        <button class="h-delete-btn" (click)="confirmDeleteMatch(i)">üóë Delete</button>
      </div>

    </div>
  </div>

  <button class="fab-add" (click)="openModal()">+</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     E-CODE PROMPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" *ngIf="showECodePrompt" (click)="$event.stopPropagation()">
  <div class="modal" style="border-radius:22px; padding:32px 24px;">
    <h2>E-CODE REQUIRED</h2>
    <p class="modal-sub">ENTER YOUR ACCESS CODE TO CONTINUE</p>
    <div class="dt-field" style="margin-bottom:16px;">
      <label>üîë E-Code</label>
      <input type="password" [(ngModel)]="eCodeInput" placeholder="Enter E-Code"
        (keyup.enter)="submitECode()" style="letter-spacing:4px; text-transform:uppercase;" />
    </div>
    <div *ngIf="eCodeError" style="color:#FF4444; font-family:'Barlow Condensed',sans-serif; font-size:12px; letter-spacing:1px; margin-bottom:12px;">
      ‚ö† {{ eCodeError }}
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="cancelECode()">Cancel</button>
      <button class="btn btn-submit" (click)="submitECode()">Unlock ‚ö°</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DELETE CONFIRM DIALOG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" *ngIf="showDeleteConfirm" (click)="$event.stopPropagation()">
  <div class="modal" style="border-radius:22px; padding:32px 24px;">
    <h2 style="color:#FF4444;">DELETE MATCH?</h2>
    <p class="modal-sub">THIS WILL REMOVE THE MATCH AND RECALCULATE ALL STATS. THIS CANNOT BE UNDONE.</p>
    <div style="display:flex; justify-content:center; font-size:48px; margin:20px 0;">üóëÔ∏è</div>
    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="cancelDelete()">Cancel</button>
      <button class="btn" style="background:linear-gradient(135deg,#FF4444,#aa1111); color:#fff; box-shadow:0 4px 16px rgba(255,68,68,.3);"
        (click)="executeDelete()">Yes, Delete ‚úì</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ADD / EDIT MATCH MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" *ngIf="showModal" (click)="onOverlayClick($event)">
  <div class="modal" id="addModal">
    <button class="modal-close" (click)="closeModal()">‚úï</button>
    <h2>{{ editIndex !== null ? 'EDIT MATCH' : 'ADD MATCH' }}</h2>
    <p class="modal-sub">{{ editIndex !== null ? 'EDIT RESULT ¬∑ STATS RECALCULATE AUTOMATICALLY' : 'LOG A NEW RESULT ¬∑ STATS UPDATE AUTOMATICALLY' }}</p>

    <div class="dt-row">
      <div class="dt-field">
        <label>üìÖ Date</label>
        <input type="date" [(ngModel)]="matchDate" />
      </div>
      <div class="dt-field">
        <label>üïê Time</label>
        <input type="time" [(ngModel)]="matchTime" />
      </div>
    </div>

    <div class="result-section">
      <div class="result-label">Match Result ‚Äî Shakthi's Perspective</div>
      <div class="result-toggle">
        <button class="r-btn" [class.active-win]="currentResult === 'win'" (click)="setResult('win')">
          <span class="r-icon">üèÜ</span>SHAKTHI WINS
        </button>
        <button class="r-btn" [class.active-draw]="currentResult === 'draw'" (click)="setResult('draw')">
          <span class="r-icon">ü§ù</span>DRAW
        </button>
        <button class="r-btn" [class.active-loss]="currentResult === 'loss'" (click)="setResult('loss')">
          <span class="r-icon">ü•á</span>SHYNU WINS
        </button>
      </div>
    </div>

    <div class="totals-bar">
      <div class="tot-side me-t">
        <div class="tot-num">{{ myTotal }}</div>
        <div class="tot-label">{{ me?.name || 'Shakthi' }}</div>
      </div>
      <div class="tot-center">VS</div>
      <div class="tot-side frd-t">
        <div class="tot-num">{{ friendTotal }}</div>
        <div class="tot-label">{{ friend?.name || 'Shynu' }}</div>
      </div>
    </div>

    <div class="goals-container">
      <div class="g-col me-col">
        <div class="g-player gp-me">{{ me?.name || 'SHAKTHI' }} ‚öΩ</div>
        <div class="g-row" *ngFor="let g of myGoalFields">
          <div class="g-icon">{{ g.icon }}</div>
          <div class="g-name">{{ g.label }}</div>
          <div class="g-stepper">
            <button class="step-btn" (click)="change(g.key, -1)">‚àí</button>
            <div class="step-val">{{ match[g.key] }}</div>
            <button class="step-btn" (click)="change(g.key, 1)">+</button>
          </div>
        </div>
      </div>
      <div class="g-divider"></div>
      <div class="g-col frd-col">
        <div class="g-player gp-frd">‚öΩ {{ friend?.name || 'SHYNU' }}</div>
        <div class="g-row frd-row" *ngFor="let g of friendGoalFields">
          <div class="g-icon">{{ g.icon }}</div>
          <div class="g-name">{{ g.label }}</div>
          <div class="g-stepper">
            <button class="step-btn" (click)="change(g.key, -1)">‚àí</button>
            <div class="step-val">{{ match[g.key] }}</div>
            <button class="step-btn" (click)="change(g.key, 1)">+</button>
          </div>
        </div>
      </div>
    </div>

    <div class="og-section">
      <div class="og-title">üò¨ Own Goals ‚Äî scored into own net</div>
      <div class="og-row">
        <div class="og-item">
          <label>{{ me?.name || 'Shakthi' }} OG ‚Üí counts for {{ friend?.name || 'Shynu' }}</label>
          <div class="g-stepper">
            <button class="step-btn" (click)="change('me_og', -1)">‚àí</button>
            <div class="step-val">{{ match.me_og }}</div>
            <button class="step-btn" (click)="change('me_og', 1)">+</button>
          </div>
        </div>
        <div class="og-item">
          <label>{{ friend?.name || 'Shynu' }} OG ‚Üí counts for {{ me?.name || 'Shakthi' }}</label>
          <div class="g-stepper">
            <button class="step-btn" (click)="change('fr_og', -1)">‚àí</button>
            <div class="step-val">{{ match.fr_og }}</div>
            <button class="step-btn" (click)="change('fr_og', 1)">+</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeModal()">Cancel</button>
      <button class="btn btn-submit" [disabled]="submitLoading || !currentResult" (click)="submitMatch()">
        {{ submitLoading ? 'Saving‚Ä¶' : (editIndex !== null ? 'Update Match ‚úì' : 'Submit Match ‚öΩ') }}
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" [class.show]="toastVisible">{{ toastMessage }}</div>